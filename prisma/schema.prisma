generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int            @id @default(autoincrement())
  name            String
  email           String         @unique
  password        String
  type            String
  active          Boolean        @default(true)
  creationDate    DateTime       @default(now())
  cpf             String
  cnpj            String?
  phone           String
  address         String?
  city            String?
  state           String?
  zipCode         String?

  refreshTokens RefreshToken[]
  vehicles      Vehicle[]      @relation("UserVehicles")
  
  diagnosesAsMechanic Diagnosis[] @relation("ResponsibleMechanicDiagnoses")
  budgets        Budget[]
  serviceOrders  ServiceOrder[] @relation("CustomerOrders")
}

model RefreshToken {
  id          Int       @id @default(autoincrement())
  token       String    @unique
  userId      Int
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Vehicle {
  id              Int       @id @default(autoincrement())
  idPlate         String
  type            String
  model           String
  brand           String
  manufactureYear Int
  modelYear       Int
  color           String
  ownerId         Int
  deletedAt       DateTime?

  owner           User      @relation("UserVehicles", fields: [ownerId], references: [id], onDelete: Restrict)
  
  diagnoses       Diagnosis[]

  @@unique([idPlate])
  @@index([ownerId])
  @@index([deletedAt])
}

model Diagnosis {
  id                    Int       @id @default(autoincrement())
  description           String
  creationDate          DateTime  @default(now())
  vehicleId             Int
  responsibleMechanicId Int?
  deletedAt             DateTime?

  vehicle               Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  responsibleMechanic   User?     @relation("ResponsibleMechanicDiagnoses", fields: [responsibleMechanicId], references: [id], onDelete: SetNull) 

  @@index([vehicleId])
  @@index([responsibleMechanicId])
  @@index([deletedAt])

  budgets      Budget[]
}

model VehiclePart {
  id           Int       @id @default(autoincrement())
  type         String
  name         String
  description  String
  quantity     Int
  price        Float
  deletedAt    DateTime?
  creationDate DateTime  @default(now())

  @@index([name])
  @@index([deletedAt])

  budgetParts  BudgetVehiclePart[]
}

model VehicleService {
  id        Int       @id @default(autoincrement())
  name      String
  price     Float     @default(0)
  description String?
  deletedAt DateTime?

  @@index([deletedAt])
  @@index([name])

  budgets     BudgetVehicleService[]
}

model Budget {
  id           Int       @id @default(autoincrement())
  description  String
  deletedAt    DateTime?
  creationDate DateTime  @default(now())
  ownerId      Int
  diagnosisId  Int
  total        Float     @default(0)

  owner     User      @relation(fields: [ownerId], references: [id])
  diagnosis Diagnosis @relation(fields: [diagnosisId], references: [id])

  vehicleParts    BudgetVehiclePart[]
  vehicleServices BudgetVehicleService[]

  serviceOrder   ServiceOrder?  @relation("OrderBudget")
}

model BudgetVehiclePart {
  id            Int         @id @default(autoincrement())
  budgetId      Int
  vehiclePartId Int
  quantity      Int

  budget      Budget      @relation(fields: [budgetId], references: [id])
  vehiclePart VehiclePart @relation(fields: [vehiclePartId], references: [id])

  @@unique([budgetId, vehiclePartId])
}

model BudgetVehicleService {
  id               Int             @id @default(autoincrement())
  budgetId         Int
  vehicleServiceId Int

  budget        Budget        @relation(fields: [budgetId], references: [id])
  vehicleService VehicleService @relation(fields: [vehicleServiceId], references: [id])

  @@unique([budgetId, vehicleServiceId])
}

enum ServiceOrderStatus {
  RECEBIDA
  AGUARDANDO_INICIO
  RECUSADA
  EM_ANDAMENTO
  CONCLUIDA
}

model ServiceOrder {
  idServiceOrder Int               @id @default(autoincrement())
  active         Boolean           @default(true)
  currentStatus  ServiceOrderStatus

  budgetId       Int? @unique
  budget       Budget?   @relation("OrderBudget", fields: [budgetId], references: [id])

  customerId     Int
  customer User    @relation("CustomerOrders", fields: [customerId], references: [id])
}